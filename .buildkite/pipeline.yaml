# There are two reasons we intentionally put everything we can on mac machine:
#  - our mac machine has 12 cores, while linux one has 4 cores.
#  - we use macs for development thus we want to make sure all scripts run there

steps:
  - label: ":linux: linters.sh"
    command: .buildkite/linters.sh
    agents:
      os: linux
  - label: ":mac: test-static-sanitized.sh"
    command: .buildkite/test-static-sanitized.sh
    agents:
      os: mac
  - label: ":linux: test-static-sanitized.sh"
    command: .buildkite/test-static-sanitized.sh
    agents:
      os: linux
  - label: ":mac: build-website.sh"
    command: .buildkite/build-website.sh
    artifact_paths: _out_/**/*
    agents:
      os: mac
  - label: ":mac: build-sorbet-runtime.sh"
    command: .buildkite/build-sorbet-runtime.sh
    artifact_paths: _out_/**/*
    agents:
      os: mac
  - wait: ~
  - label: ":mac: build-static-release.sh"
    command: .buildkite/build-static-release.sh
    artifact_paths: _out_/**/*
    agents:
      os: mac
  - label: ":mac: build-emscripten.sh"
    command: .buildkite/build-emscripten.sh
    artifact_paths: _out_/**/*
    agents:
      os: mac
  - label: ":linux: build-static-release.sh"
    command: .buildkite/build-static-release.sh
    artifact_paths: _out_/**/*
    agents:
      os: linux
  - wait: ~
    # TODO(jez) Test on linux
  - label: ":mac: test-sorbet-gem.sh"
    command: .buildkite/test-sorbet-gem.sh
    agents:
      os: mac
  - wait: ~
  - label: ":linux: publish.sh"
    command: .buildkite/publish.sh
    agents:
      os: linux
  - wait: ~
  - label: "All tests and builds succeeded"
    command: .buildkite/all-succeeded.sh
  - block: "Run optional code coverage"
  - wait: ~
  - label: ":mac: coverage-static-sanitized.sh"
    command: .buildkite/coverage-static-sanitized.sh
    artifact_paths: _out_/**/*
    retry:
      automatic: true
    agents:
      os: mac
